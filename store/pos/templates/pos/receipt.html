{% load humanize %}
<style>
    #uni_modal .modal-footer {
        display: none
    }
    
    /* Estilos para impresora térmica 58mm */
    @media print {
        @page {
            size: 58mm auto;
            margin: 0mm;
        }
        
        body {
            margin: 0;
            padding: 2mm 1mm;
            font-family: 'Courier New', monospace;
            font-size: 9pt;
            line-height: 1.2;
        }
        
        * {
            font-weight: normal !important;
        }
        
        .no-print {
            display: none !important;
        }
    }
    
    #outprint {
        width: 56mm;
        margin: 0 auto;
        font-family: 'Courier New', monospace;
        font-size: 10pt;
        line-height: 1.3;
    }
    
    .text-center {
        text-align: center;
    }
    
    .text-end {
        text-align: right;
    }
    
    .separator {
        border-top: 1px dashed #000;
        margin: 3px 0;
    }
    
    .item-row {
        display: flex;
        justify-content: space-between;
        margin: 2px 0;
    }
    
    .item-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 32mm;
    }
    
    .item-qty {
        width: 8mm;
        text-align: center;
    }
    
    .item-price {
        width: 16mm;
        text-align: right;
    }
</style>

<div class="container-fluid">
    <div id="outprint">
        <!-- Encabezado -->
        <div class="text-center">
            <div style="font-size: 11pt;">PUNTO DE VENTA</div>
            <div style="font-size: 9pt;">Recibo no oficial</div>
        </div>
        
        <div class="separator"></div>
        
        <!-- Fecha y código -->
        <div style="font-size: 9pt; margin: 3px 0;">
            <div>Fecha: {{ formatted_date }}</div>
            <div>Ticket: {{ transaction.code }}</div>
        </div>
        
        <div class="separator"></div>
        
        <!-- Encabezado tabla -->
        <div style="display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 2px;">
            <div style="width: 8mm;">Cant</div>
            <div style="flex: 1;">Producto</div>
            <div style="width: 16mm; text-align: right;">Total</div>
        </div>
        
        <div style="border-top: 1px solid #000; margin: 2px 0;"></div>
        
        <!-- Items -->
        {% for item in salesItems %}
        <div style="margin: 3px 0; font-size: 9pt;">
            <div style="display: flex; justify-content: space-between;">
                <div style="width: 8mm;">{{ item.qty|floatformat:0 }}</div>
                <div style="flex: 1; overflow: hidden; text-overflow: ellipsis;">{{ item.product }}</div>
                <div style="width: 16mm; text-align: right;">${{ item.total|floatformat:0 }}</div>
            </div>
            <div style="padding-left: 9mm; font-size: 8pt; color: #555;">@ ${{ item.price|floatformat:0 }} c/u</div>
        </div>
        {% endfor %}
        
        <div style="border-top: 1px solid #000; margin: 4px 0;"></div>
        
        <!-- Totales -->
        <div style="font-size: 10pt;">
            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                <div>TOTAL:</div>
                <div style="font-size: 12pt;">${{ transaction.grand_total|floatformat:0 }}</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                <div>Recibido:</div>
                <div>${{ transaction.tendered_amount|floatformat:0 }}</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                <div>Vuelto:</div>
                <div>${{ transaction.amount_change|floatformat:0 }}</div>
            </div>
        </div>
        
        <div class="separator"></div>
        
        <!-- Pie -->
        <div class="text-center" style="font-size: 8pt; margin-top: 4px;">
            <div>Gracias por su compra!</div>
        </div>
        
        <!-- Espacio final mínimo -->
        <div style="height: 5mm;"></div>
    </div>
    
    <hr class="no-print">
    
    <!-- Botones (no se imprimen) -->
    <div class="d-flex w-100 justify-content-end no-print">
        <button class="btn btn-light bg-gradient border rounded-0 btn-sm me-1" type="button" id="receipt_print">
            <i class="mdi mdi-printer"></i> Imprimir
        </button>
        <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" data-bs-dismiss="modal">
            <i class="mdi mdi-close"></i> Cerrar
        </button>
    </div>
</div>

<script>
    $(function() {
        $('#receipt_print').click(function() {
            var head = $('head').clone();
            var p = $('#outprint').clone();
            var el = $("<div>");
            
            // Estilos para impresión térmica
            head.append(`
                <style>
                    @page {
                        size: 58mm auto;
                        margin: 0mm;
                    }
                    body {
                        margin: 0;
                        padding: 2mm 1mm;
                        font-family: 'Courier New', monospace;
                        font-size: 9pt;
                        line-height: 1.2;
                        background-color: white !important;
                    }
                    * {
                        font-weight: normal !important;
                    }
                </style>
            `);
            
            el.append(head);
            el.find('title').text("Recibo - Vista Impresión");
            el.append(p);
            
            start_loader();
            var nw = window.open('', '_blank', "width=250,height=600,left=300,top=200");
            nw.document.write(el.html());
            nw.document.close();
            
            setTimeout(() => {
                nw.print();
                setTimeout(() => {
                    nw.close();
                    end_loader();
                }, 250);
            }, 300);
        });
    });
</script>
